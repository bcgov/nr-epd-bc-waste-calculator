name: Convert Excel to JSON

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Download File from S3 Bucket and Commit to Repo"]
    types:
      - completed

jobs:
  convert-excel-to-json:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Ensure repo is up to date BEFORE modifying files
      - name: Sync with main
        run: |
          git fetch origin
          git checkout main
          git pull origin main

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl

      # Convert facility Excel → JSON
      - name: Convert facility Excel to JSON
        run: |
          python script/convert.py import/msw_in_region_disposal.xlsx export/output.json

      # Convert municipality Excel → JSON
      - name: Convert municipality Excel to JSON
        run: |
          python script/convertmun.py import/pop_municipal_subprov_areas.xlsx export/output2.json

      # Commit & push only if files changed
      - name: Commit and push JSON output
        run: |
          git config --global user.name "AmanBhathal"
          git config --global user.email "amandeep.bhathal@gov.bc.ca"

          git status
          git add export/*.json

          git diff --cached --quiet && echo "No changes to commit" && exit 0

          git commit -m "Automated update: Excel to JSON"
          git push origin main
